#include <tunables/global>

profile docker-tor-hardened-rust flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice> # Essential for DNS/SSL resolution

  # === THE BINARY ===
  # The new static binary is at the root of the container
  /torrust rmix,

  # === READ-ONLY SYSTEM FILES ===
  # Required for Arti (Tor) to verify TLS certificates
  /etc/ssl/certs/** r,
  /etc/pki/tls/certs/** r,
  /usr/share/ca-certificates/** r,
  
  # Basic system reads (CPU/Mem info for optimizations)
  @{PROC}/sys/kernel/random/uuid r,
  @{PROC}/sys/kernel/osrelease r,
  @{PROC}/meminfo r,

  # === NETWORK ===
  network inet tcp,
  network inet udp,
  # Security: Deny raw socket creation (prevents packet crafting)
  deny network raw,

  # === CAPABILITIES ===
  # Required for SECMEM (preventing RAM swapping to disk)
  capability ipc_lock,

  # === DENY EVERYTHING ELSE ===
  # Since we are FROM scratch, there is no shell, no /bin, no /tmp
  # We explicitly deny writing anywhere.
  deny /** w,
  
  # Allow writing only to stdout/stderr (handled by Docker)
  # No explicit rule needed usually, but 'file' rules cover it.
}